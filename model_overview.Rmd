---
author: "Ruben Arslan"
date: "7 November 2016"
output:
  pdf_document: default
  html_document: default
---

<style>
table {
float:left
}
</style>

# Model Overview {.tabset}

```{r results='asis', warning=F,message=F,echo=FALSE,fig.width=5,fig.height=5}
library(formr)
library(ggplot2)
library(dplyr)
library(pander)
library(readr)
library(stringr)
files = list.files(path = "../Pedigree variants/Output/", pattern = ".hsq$", recursive = T, full.names = F)
files = na.omit(str_match(files, pattern = "(.+?)/(.+?)/(.+?)\\_model\\.hsq"))
last = F
models = tbl_df(data.frame(domain = character(0), aspect = character(0), model = character(0), Component = character(0), Variance = double(0), SE = double()))
for (i in seq_along(1:nrow(files))) {
	model = read_tsv(file = paste0("../Pedigree variants/Output/", files[i, 1]), col_names = T)
	if (files[i, 3] != last) {
		model_comparisons = tbl_df(data.frame(model = character(0), logL = double(0)))
		cat("\n\n\n## ",files[i, 2] ,files[i, 3], " {.tabset}\n\n\n")
		last = files[i, 3]
	}
	curfile = files[i, ]
	poss_components = component = c("G", "K", "F", "S", "C")
	included_comps = files[i,4]
	if(included_comps == "Full") {
		included_comps = "GKFSC"
	} else if (included_comps == "Selected") {
		included_comps = ""
	}
	components = poss_components[included_comps %contains% poss_components ]
	if(length(components) > 1) {
		sources = paste0("V(G", 1:length(components), ")")
	} else if (length(components) == 1) {
		sources = "V(G)"
	} else {
		sources = character(0)
	}
	components = data.frame(Component = components, Source = sources)
	components = components %>% bind_rows(components %>% mutate(Source = paste0(Source, "/Vp"), Component = paste0(Component, "%")))
	model = model %>% left_join(components, by = "Source") %>% mutate(Component = ifelse(is.na(Component), Source, Component)) %>% select(Component, Variance, SE)
	
	cat("\n\n\n### ",files[i, 4],"\n\n\n")
	cat(pander(model))
	
	model %>% filter(Component %ends_with% "%" | Component %ends_with% "/Vp") -> std_vars
	if(std_vars$Component[1] %contains% "Vp") {
		std_vars$Component = factor(std_vars$Component, levels = c("V(G1)/Vp", "V(G2)/Vp", "V(G3)/Vp", "V(G4)/Vp", "V(G5)/Vp"))
	} else {
		std_vars$Component = factor(std_vars$Component, levels = c("G%", "K%", "F%", "S%", "C%"))
	}
	# std_vars$Component = droplevels(std_vars$Component)
	cat("<div style='float:right'>")
	print(
	ggplot(std_vars, 
				 aes(x = Component, y = Variance, ymax = Variance + SE, ymin = ifelse(Variance - SE<=0, 0, Variance - SE))) + 
		geom_linerange() + 
		geom_bar(stat='identity', width = 0.5, alpha = 0.5) + 
		coord_flip() + 
		scale_x_discrete(limits = rev(levels(std_vars$Component)), drop = F) + 
		theme_bw() + 
		theme(panel.grid.major.y = element_blank(), panel.grid.minor.y = element_blank()) + 
		scale_y_continuous(limits = c(0,1))
		)
	cat("</div>")
	
	models = bind_rows(models, model %>% mutate(domain = files[i,2], aspect = files[i, 3], model = files[i, 4]))
	
	e = 1 + nrow(model_comparisons)
	model_comparisons[e , "model"] = files[i, 4]
	model_comparisons[e , "logL"] = model %>% filter(Component == "logL") %>% .[["Variance"]]
	
	if (i == NROW(files) || files[i+1, 3] != last) {
		if (last != F) {
			cat("\n\n\\newpage\n\n### Model comparison\n\n\n")
			model_comparisons %>% arrange(logL) %>% mutate(ln_diff2 = 2 * (logL - lag(logL))) %>%
			pander() %>% cat()
		}
	}
	cat("\n\n\n\\newpage\n\n\n")
}

cat("\n\n\n## All models\n\n")
pander(models)
```

